name: Test and Approval Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      run_id:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      environment:
        description: "The environment to deploy to"
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  build-and-test-dev:
    runs-on: ubuntu-latest
    outputs:
      artifact-url: ${{ steps.notify.outputs.artifact-url }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build Project
        run: mvn clean install

      - name: Run Cucumber Tests (DEV)
        run: mvn test -Dcucumber.filter.tags="@DEV"

      - name: Archive Reports (DEV)
        uses: actions/upload-artifact@v4
        with:
          name: dev-test-reports
          path: |
            reports/extent-report.html
            reports/screenshots/

      - name: Notify Manager with Test Report and Approval Link
        id: notify
        uses: actions/github-script@v6
        with:
          script: |
            const repository = context.repo.repo;
            const owner = context.repo.owner;
            const runId = "${{ inputs.run_id }}";
            const environment = "${{ inputs.environment }}";

            const workflowUrl = `https://github.com/${owner}/${repository}/actions/runs/${runId}`;
            const artifactUrl = `https://github.com/${owner}/${repository}/suites/${runId}/artifacts`;

            const subject = "Test Execution Complete - Approval Needed";
            const message = `
            **Subject:** ${subject}
            Hi there,
            Test execution for *${environment}* is complete. Please review the test report:

            üîó [Download Test Report](${artifactUrl})  
            üîç [Workflow Details](${workflowUrl})

            ‚úÖ To approve and proceed to deployment, please visit:  
            [Approve Deployment](${workflowUrl})

            Thanks,  
            GitHub-BMO
            `;

            console.log(message);

            await github.rest.repos.createCommitComment({
              owner: owner,
              repo: repository,
              commit_sha: context.sha,
              body: message,
            });

            return artifactUrl;

  wait-for-approval:
    runs-on: ubuntu-latest
    needs: build-and-test-dev
    environment:
      name: ${{ inputs.environment }}
      # This triggers GitHub Environment protection rules (like manual approval)
    steps:
      - name: Wait for manual approval
        run: echo "üü° Waiting for manager approval..."

  deploy:
    runs-on: ubuntu-latest
    needs: wait-for-approval
    steps:
      - name: Deploy to ${{ inputs.environment }}
        run: echo "üöÄ Deploying to ${{ inputs.environment }}..."
